name: iOS Build

on:
  push:
    branches:
      - main
      - develop
      - 'release/**'
    paths:
      - 'ios/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'ios/**'
      - '.github/workflows/build.yml'
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: true
        default: 'Debug'
        type: choice
        options:
          - Debug
          - Release
      create_archive:
        description: 'Create archive and IPA'
        required: false
        default: false
        type: boolean
      upload_artifacts:
        description: 'Upload build artifacts'
        required: false
        default: true
        type: boolean

env:
  XCODE_VERSION: '15.2'
  IOS_DEPLOYMENT_TARGET: '17.0'

jobs:
  build:
    name: Build iOS App
    runs-on: macos-14

    strategy:
      matrix:
        # å®šä¹‰æž„å»ºé…ç½®çŸ©é˜µ
        include:
          - configuration: ${{ github.event.inputs.configuration || 'Debug' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Install XcodeGen
        run: |
          brew install xcodegen
          xcodegen --version

      - name: Generate Xcode project
        working-directory: ./ios
        run: |
          echo "Generating Xcode project..."
          ./scripts/generate_project.sh

      - name: Cache derived data
        uses: actions/cache@v4
        with:
          path: |
            ios/build/DerivedData
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-derived-data-${{ hashFiles('ios/**/*.swift', 'ios/project.yml') }}
          restore-keys: |
            ${{ runner.os }}-derived-data-

      - name: Build for Simulator
        if: ${{ !github.event.inputs.create_archive }}
        working-directory: ./ios
        run: |
          echo "Building for iOS Simulator..."
          ./scripts/build.sh \
            ${{ matrix.configuration == 'Release' && '-r' || '' }} \
            -d simulator
        continue-on-error: false

      - name: Build Archive and IPA
        if: ${{ github.event.inputs.create_archive == 'true' }}
        working-directory: ./ios
        run: |
          echo "Creating archive and IPA..."
          ./scripts/build.sh -a -r
        continue-on-error: false

      - name: Collect build logs
        if: always()
        working-directory: ./ios
        run: |
          echo "Collecting build logs..."
          mkdir -p build/logs

          # å¤åˆ¶æ‰€æœ‰æž„å»ºæ—¥å¿—
          if [ -d "build" ]; then
            find build -name "*.log" -exec cp {} build/logs/ \; || true
          fi

          # åˆ›å»ºæž„å»ºæ‘˜è¦
          cat > build/logs/build-summary.txt <<EOF
          Build Summary
          =============
          Date: $(date)
          Configuration: ${{ matrix.configuration }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Triggered by: ${{ github.event_name }}
          EOF

          # å¦‚æžœæœ‰é”™è¯¯æ—¥å¿—,æ·»åŠ åˆ°æ‘˜è¦
          if [ -d "build" ]; then
            echo "" >> build/logs/build-summary.txt
            echo "Recent errors:" >> build/logs/build-summary.txt
            find build -name "*.log" -exec grep -i "error:" {} \; | tail -20 >> build/logs/build-summary.txt || true
          fi

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.configuration }}-${{ github.run_number }}
          path: |
            ios/build/logs/
            ios/build/*.log
          retention-days: 30

      - name: Upload build artifacts
        if: ${{ (success() && github.event.inputs.upload_artifacts != 'false') || github.event.inputs.create_archive == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.configuration }}-${{ github.run_number }}
          path: |
            ios/build/**/*.app
            ios/build/**/*.ipa
            ios/build/**/*.xcarchive
          retention-days: 7

      - name: Build status summary
        if: always()
        run: |
          echo "### Build Results ðŸ“±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Configuration**: ${{ matrix.configuration }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Xcode Version**: ${{ env.XCODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Target**: ${{ env.IOS_DEPLOYMENT_TARGET }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "ios/build/logs/build-summary.txt" ]; then
            echo "#### Build Summary" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat ios/build/logs/build-summary.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
