name: iOS Archive Build (Signed)

on:
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: true
        default: 'Release'
        type: choice
        options:
          - Debug
          - Release

      export_method:
        description: 'Export method'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - ad-hoc
          - app-store

      upload_artifacts:
        description: 'Upload IPA artifact'
        required: false
        default: true
        type: boolean

env:
  XCODE_VERSION: '15.2'

jobs:
  build-and-sign:
    name: Build and Sign iOS Archive
    runs-on: macos-14

    steps:
      - name: Print configuration
        run: |
          echo "### Build Configuration üîß" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Configuration**: ${{ github.event.inputs.configuration }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Export Method**: ${{ github.event.inputs.export_method }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Install XcodeGen
        run: |
          brew install xcodegen
          xcodegen --version

      - name: Check signing secrets
        run: |
          echo "Checking if signing secrets are configured..."

          if [ -z "${{ secrets.CERTIFICATE_P12_BASE64 }}" ]; then
            echo "‚ùå CERTIFICATE_P12_BASE64 secret is not set"
            echo ""
            echo "### ‚ö†Ô∏è ‰ª£Á†ÅÁ≠æÂêçÈÖçÁΩÆÁº∫Â§±" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ËØ∑ÈÖçÁΩÆ‰ª•‰∏ã GitHub Secrets:" >> $GITHUB_STEP_SUMMARY
            echo "- CERTIFICATE_P12_BASE64" >> $GITHUB_STEP_SUMMARY
            echo "- CERTIFICATE_PASSWORD" >> $GITHUB_STEP_SUMMARY
            echo "- PROVISIONING_PROFILE_BASE64" >> $GITHUB_STEP_SUMMARY
            echo "- KEYCHAIN_PASSWORD" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ËØ¶ÁªÜÈÖçÁΩÆÊåáÂçó: .github/CODE-SIGNING-GUIDE.md" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "‚úÖ Signing secrets are configured"

      - name: Create keychain and import certificate
        env:
          CERTIFICATE_P12_BASE64: ${{ secrets.CERTIFICATE_P12_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo "Creating temporary keychain..."

          # ÂàõÂª∫‰∏¥Êó∂ keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "Importing certificate..."

          # Ëß£Á†ÅÂπ∂ÂØºÂÖ•ËØÅ‰π¶
          echo "$CERTIFICATE_P12_BASE64" | base64 --decode > certificate.p12

          security import certificate.p12 \
            -P "$CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # ËÆæÁΩÆ keychain ‰∏∫ÈªòËÆ§
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # ÂÖÅËÆ∏ codesign ËÆøÈóÆËØÅ‰π¶
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "‚úÖ Certificate imported successfully"

          # È™åËØÅËØÅ‰π¶
          echo "Installed identities:"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Install provisioning profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
        run: |
          echo "Installing provisioning profile..."

          # ÂàõÂª∫ provisioning profiles ÁõÆÂΩï
          PP_DIR=~/Library/MobileDevice/Provisioning\ Profiles
          mkdir -p "$PP_DIR"

          # Ëß£Á†ÅÂπ∂ÂÆâË£Ö profile
          PP_PATH=$RUNNER_TEMP/profile.mobileprovision
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > "$PP_PATH"

          # Ëé∑Âèñ profile UUID
          PP_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< $(security cms -D -i "$PP_PATH"))

          # Â§çÂà∂Âà∞Ê≠£Á°Æ‰ΩçÁΩÆ
          cp "$PP_PATH" "$PP_DIR/$PP_UUID.mobileprovision"

          echo "‚úÖ Provisioning profile installed: $PP_UUID"

          # ÊòæÁ§∫ profile ‰ø°ÊÅØ
          echo "Profile details:"
          security cms -D -i "$PP_PATH" | grep -A 5 "Name\|UUID\|TeamName\|ExpirationDate"

      - name: Generate Xcode project
        working-directory: ./ios
        run: |
          echo "Generating Xcode project..."
          ./scripts/generate_project.sh

      - name: Build archive
        working-directory: ./ios
        run: |
          echo "Starting archive build..."

          # ‰ΩøÁî®ÊûÑÂª∫ËÑöÊú¨Ôºà‰ΩøÁî® manual signingÔºâ
          # Ê≥®ÊÑè: Êàë‰ª¨‰∏ç‰ΩøÁî® -allowProvisioningUpdates Âõ†‰∏∫Â∑≤ÁªèÊâãÂä®ÈÖçÁΩÆ‰∫Ü

          xcodebuild archive \
            -project ThriveBody.xcodeproj \
            -scheme ThriveBody \
            -configuration ${{ github.event.inputs.configuration }} \
            -archivePath build/ThriveBody.xcarchive \
            CODE_SIGN_STYLE=Manual \
            | tee build/xcodebuild_archive.log

          echo "‚úÖ Archive created successfully"

      - name: Export IPA
        working-directory: ./ios
        run: |
          echo "Exporting IPA..."

          # ÂàõÂª∫ ExportOptions.plist
          cat > build/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>${{ github.event.inputs.export_method }}</string>
              <key>compileBitcode</key>
              <false/>
              <key>signingStyle</key>
              <string>manual</string>
              <key>stripSwiftSymbols</key>
              <true/>
          </dict>
          </plist>
          EOF

          # ÂØºÂá∫ IPA
          xcodebuild -exportArchive \
            -archivePath build/ThriveBody.xcarchive \
            -exportPath build \
            -exportOptionsPlist build/ExportOptions.plist \
            | tee build/xcodebuild_export.log

          echo "‚úÖ IPA exported successfully"

          # ÊòæÁ§∫ IPA ‰ø°ÊÅØ
          if [ -f "build/ThriveBody.ipa" ]; then
            IPA_SIZE=$(du -sh build/ThriveBody.ipa | cut -f1)
            echo "IPA Size: $IPA_SIZE"

            # Ëß£Âéã IPA Ëé∑ÂèñÊõ¥Â§ö‰ø°ÊÅØ
            unzip -q build/ThriveBody.ipa -d build/ipa_contents
            INFO_PLIST=build/ipa_contents/Payload/ThriveBody.app/Info.plist

            if [ -f "$INFO_PLIST" ]; then
              VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" "$INFO_PLIST")
              BUILD=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" "$INFO_PLIST")

              echo "App Version: $VERSION ($BUILD)"

              # Ê∑ªÂä†Âà∞ summary
              echo "### üì¶ Build Artifacts" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- **IPA Size**: $IPA_SIZE" >> $GITHUB_STEP_SUMMARY
              echo "- **Version**: $VERSION ($BUILD)" >> $GITHUB_STEP_SUMMARY
              echo "- **Configuration**: ${{ github.event.inputs.configuration }}" >> $GITHUB_STEP_SUMMARY
              echo "- **Export Method**: ${{ github.event.inputs.export_method }}" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Collect build logs
        if: always()
        working-directory: ./ios
        run: |
          echo "Collecting build logs..."
          mkdir -p build/logs

          # Â§çÂà∂Êó•Âøó
          cp build/*.log build/logs/ 2>/dev/null || true

          # ÂàõÂª∫ÊûÑÂª∫Êä•Âëä
          cat > build/logs/build-report.md <<EOF
          # iOS Archive Build Report

          ## Configuration
          - **Date**: $(date)
          - **Configuration**: ${{ github.event.inputs.configuration }}
          - **Export Method**: ${{ github.event.inputs.export_method }}
          - **Branch**: ${{ github.ref_name }}
          - **Commit**: ${{ github.sha }}
          - **Triggered by**: @${{ github.actor }}

          ## Environment
          - **Xcode Version**: $(xcodebuild -version | head -1)
          - **macOS Version**: $(sw_vers -productVersion)
          - **Runner**: ${{ runner.os }} - ${{ runner.arch }}

          ## Build Results
          EOF

          # Ê∑ªÂä† IPA ‰ø°ÊÅØ
          if [ -f "build/ThriveBody.ipa" ]; then
            echo "### IPA Details" >> build/logs/build-report.md
            echo "- Size: $(du -sh build/ThriveBody.ipa | cut -f1)" >> build/logs/build-report.md
            echo "- Path: \`build/ThriveBody.ipa\`" >> build/logs/build-report.md
          fi

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: archive-build-logs-${{ github.run_number }}
          path: |
            ios/build/logs/
            ios/build/*.log
          retention-days: 30
          if-no-files-found: warn

      - name: Upload IPA
        if: ${{ success() && github.event.inputs.upload_artifacts == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ThriveBody-${{ github.event.inputs.configuration }}-${{ github.event.inputs.export_method }}-${{ github.run_number }}
          path: |
            ios/build/ThriveBody.ipa
            ios/build/ThriveBody.xcarchive
          retention-days: 30
          if-no-files-found: error

      - name: Upload to TestFlight (Optional)
        if: |
          success() &&
          github.event.inputs.export_method == 'app-store' &&
          secrets.APP_STORE_CONNECT_API_KEY_BASE64 != ''
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          echo "Uploading to TestFlight..."

          # ‰øùÂ≠ò API Key
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$API_KEY_BASE64" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${API_KEY_ID}.p8

          # ‰∏ä‰º†
          xcrun altool --upload-app \
            --type ios \
            --file ios/build/ThriveBody.ipa \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$API_ISSUER_ID"

          echo "‚úÖ Uploaded to TestFlight"

      - name: Cleanup keychain
        if: always()
        run: |
          echo "Cleaning up keychain..."
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
            echo "‚úÖ Keychain deleted"
          fi

      - name: Generate summary
        if: always()
        run: |
          echo "### Build Summary üìä" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "ios/build/logs/build-report.md" ]; then
            cat ios/build/logs/build-report.md >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download artifacts from the Actions page" >> $GITHUB_STEP_SUMMARY
          echo "2. Install IPA on device or upload to TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "3. Review build logs for any warnings" >> $GITHUB_STEP_SUMMARY
